<!DOCTYPE html><html lang="en,default"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico"><link rel="icon" type="image/png" sizes="32x32" href="/avatar.jpg"><link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico"><link rel="mask-icon" href="/favicon.ico" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/animate-css/animate.min.css"><script class="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"hanielxx.com",root:"/",scheme:"Mala",version:"8.0.0-rc.4",exturl:!1,sidebar:{position:"right",display:"always",padding:18,offset:12},copycode:!0,bookmark:{enable:!0,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"buttons",active:"disqus",storage:!0,lazyload:!1,nav:null,activeClass:"disqus"},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"fadeInDown",post_body:"fadeInDown",coll_header:"fadeInLeft",sidebar:"fadeInUp"}},prism:!1,path:"search.xml"}</script><meta name="description" content="记录对 ClassyVision 框架的理解，以及数据处理 pipeline。中间有用到 pytorch 的分布式训练。"><meta property="og:type" content="article"><meta property="og:title" content="ClassyVision框架和多模态视频分类流程"><meta property="og:url" content="https://hanielxx.com/MachineLearning/2021-04-03-classy-vision-and-multimodal-video-classification"><meta property="og:site_name" content="Catch Your Dream"><meta property="og:description" content="记录对 ClassyVision 框架的理解，以及数据处理 pipeline。中间有用到 pytorch 的分布式训练。"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-04-03T08:11:01.000Z"><meta property="article:modified_time" content="2021-07-02T09:15:34.703Z"><meta property="article:author" content="Hanielxx"><meta property="article:tag" content="Private"><meta property="article:tag" content="DeepLearning"><meta property="article:tag" content="Pytorch"><meta property="article:tag" content="ClassyVision"><meta property="article:tag" content="MultiModal"><meta property="article:tag" content="VideoClassification"><meta property="article:tag" content="DistributedTraining"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://hanielxx.com/MachineLearning/2021-04-03-classy-vision-and-multimodal-video-classification.html"><script class="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"en"}</script><title>ClassyVision框架和多模态视频分类流程 | Catch Your Dream</title><noscript><style>body{margin-top:2rem}.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header,.use-motion .sidebar{visibility:visible}.use-motion .footer,.use-motion .header,.use-motion .site-brand-container .toggle{opacity:initial}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line{transform:scaleX(1)}.search-pop-overlay,.sidebar-nav{display:none}.sidebar-panel{display:block}</style></noscript><style>mjx-container[jax=SVG]{direction:ltr}mjx-container[jax=SVG]>svg{overflow:visible}mjx-container[jax=SVG]>svg a{fill:#00f;stroke:#00f}mjx-container[jax=SVG][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=SVG][justify=left]{text-align:left}mjx-container[jax=SVG][justify=right]{text-align:right}g[data-mml-node=merror]>g{fill:red;stroke:red}g[data-mml-node=merror]>rect[data-background]{fill:#ff0;stroke:none}g[data-mml-node=mtable]>line[data-line]{stroke-width:70px;fill:none}g[data-mml-node=mtable]>rect[data-frame]{stroke-width:70px;fill:none}g[data-mml-node=mtable]>.mjx-dashed{stroke-dasharray:140}g[data-mml-node=mtable]>.mjx-dotted{stroke-linecap:round;stroke-dasharray:0,140}g[data-mml-node=mtable]>svg{overflow:visible}[jax=SVG] mjx-tool{display:inline-block;position:relative;width:0;height:0}[jax=SVG] mjx-tool>mjx-tip{position:absolute;top:0;left:0}mjx-tool>mjx-tip{display:inline-block;padding:.2em;border:1px solid #888;font-size:70%;background-color:#f8f8f8;color:#000;box-shadow:2px 2px 5px #aaa}g[data-mml-node=maction][data-toggle]{cursor:pointer}mjx-status{display:block;position:fixed;left:1em;bottom:1em;min-width:25%;padding:.2em .4em;border:1px solid #888;font-size:90%;background-color:#f8f8f8;color:#000}foreignObject[data-mjx-xml]{font-family:initial;line-height:normal;overflow:visible}.MathJax path{stroke-width:3}mjx-container[display=true]{overflow:auto hidden}mjx-container[display=true]+br{display:none}</style><link rel="alternate" href="/atom.xml" title="Catch Your Dream" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">Catch Your Dream</h1><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-algorithm"><a href="/tags/Algorithm/" rel="section"><i class="fa fa-code fa-fw"></i>Algorithm</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><section class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#拉数据和处理"><span class="nav-number">1.</span> <span class="nav-text">拉数据和处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Info"><span class="nav-number">1.1.</span> <span class="nav-text">Info</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#run-sh-脚本说明"><span class="nav-number">1.2.</span> <span class="nav-text">run.sh 脚本说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#run-sh-导出视频相关计数"><span class="nav-number">1.3.</span> <span class="nav-text">run.sh 导出视频相关计数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#导出所有视频"><span class="nav-number">1.4.</span> <span class="nav-text">导出所有视频</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#run-sh-导出用户特征向量"><span class="nav-number">1.5.</span> <span class="nav-text">run.sh 导出用户特征向量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#run-sh-导出文本"><span class="nav-number">1.6.</span> <span class="nav-text">run.sh 导出文本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#run-sh-导出视频封面和指定帧"><span class="nav-number">1.7.</span> <span class="nav-text">run.sh 导出视频封面和指定帧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-user-list"><span class="nav-number">1.8.</span> <span class="nav-text">get_user_list</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#run-sh-导出用户特征"><span class="nav-number">1.9.</span> <span class="nav-text">run.sh 导出用户特征</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mk-train-org"><span class="nav-number">1.10.</span> <span class="nav-text">mk_train_org</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#transfer-user-pid"><span class="nav-number">1.11.</span> <span class="nav-text">transfer_user_pid</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#split-train-val"><span class="nav-number">1.12.</span> <span class="nav-text">split_train_val</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#generate-rec-for-raw-user-embeding"><span class="nav-number">1.13.</span> <span class="nav-text">generate_rec_for_raw_user_embeding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型训练"><span class="nav-number">2.</span> <span class="nav-text">模型训练</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bash-运行脚本"><span class="nav-number">2.1.</span> <span class="nav-text">bash 运行脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#参数说明"><span class="nav-number">2.1.1.</span> <span class="nav-text">参数说明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件说明"><span class="nav-number">2.2.</span> <span class="nav-text">文件说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型测试和评估"><span class="nav-number">3.</span> <span class="nav-text">模型测试和评估</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#推荐类别项目"><span class="nav-number">4.</span> <span class="nav-text">推荐类别项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关键词收集"><span class="nav-number">4.1.</span> <span class="nav-text">关键词收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据量"><span class="nav-number">4.2.</span> <span class="nav-text">数据量</span></a></li></ol></li></ol></div></section><section class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Hanielxx" src="/avatar.jpg"><p class="site-author-name" itemprop="name">Hanielxx</p><div class="site-description" itemprop="description">Hanielxx | Blog</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">130</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">183</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/HanielF" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;HanielF" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:hanielxx@outlook.com" title="E-Mail → mailto:hanielxx@outlook.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div></section></div></aside><div id="sidebar-dimmer"></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/HanielF" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><noscript><div id="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"><link itemprop="mainEntityOfPage" href="https://hanielxx.com/MachineLearning/2021-04-03-classy-vision-and-multimodal-video-classification"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/avatar.jpg"><meta itemprop="name" content="Hanielxx"><meta itemprop="description" content="Hanielxx | Blog"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Catch Your Dream"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">ClassyVision框架和多模态视频分类流程</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-04-03 16:11:01" itemprop="dateCreated datePublished" datetime="2021-04-03T16:11:01+08:00">2021-04-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">Edited on</span> <time title="Modified: 2021-07-02 17:15:34" itemprop="dateModified" datetime="2021-07-02T17:15:34+08:00">2021-07-02</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MachineLearning/" itemprop="url" rel="index"><span itemprop="name">MachineLearning</span></a> </span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Disqus: </span><a title="disqus" href="/MachineLearning/2021-04-03-classy-vision-and-multimodal-video-classification#disqus_thread" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="MachineLearning/2021-04-03-classy-vision-and-multimodal-video-classification.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Symbols count in article: </span><span>13k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>32 mins.</span></span></div></header><div class="post-body" itemprop="articleBody"><meta name="referrer" content="no-referrer"><div class="note info"><p>记录对 ClassyVision 框架的理解，以及数据处理 pipeline。中间有用到 pytorch 的分布式训练。</p></div><a id="more"></a><h2 id="拉数据和处理"><a href="#拉数据和处理" class="headerlink" title="拉数据和处理"></a>拉数据和处理</h2><ol><li>先处理数据得到<code>videos.txt</code>，每行一个 pid</li><li>然后得到 pid-label 的类似<code>saishi_train_data_v3.txt</code>的文件。</li><li>然后得到<code>视频ID,概率值,标签,描述</code>的数据回查文件。</li><li>然后拉取数据，就是<code>run.sh</code></li><li>然后生成</li></ol><h3 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h3><ul><li>登录拉数据 webserver<ul><li><code>ssh xudi06@relay.corp.kuaishou.com</code></li><li><code>ssh web_server@bjpg-rs8553.yz02 -p22</code></li></ul></li><li><code>df -h</code>找到 mmu 项目路径<code>/mnt/mmu_ssd/share/yangfan/yuanwei/xingshisenlin_saishi</code></li><li>查看<code>run.sh</code></li><li>如果提示文件不存在类似信息，查看是否切换到webserver用户，是否有权限</li><li>如果执行出错，可能存在隐藏字符无法执行，自己手打试试</li></ul><h3 id="run-sh-脚本说明"><a href="#run-sh-脚本说明" class="headerlink" title="run.sh 脚本说明"></a>run.sh 脚本说明</h3><ul><li><p><code>run.sh</code>脚本文件</p></li><li><p>命令：webserver 下<code>bash run.sh</code></p></li><li><p>功能：拉取视频相关计数、特征、文本、视频封面和指定帧、用户特征</p></li><li><p>生成：<code>users.txt，author_2tower_embedding_by_photo_id，text.txt，cover目录，users_list.txt，users_list_out.txt</code></p></li><li><p>users_list 需要自己手动通过<code>users.txt</code>生成</p></li><li><p>准备说明：</p><ul><li>videos.txt: 每行一个 pid</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nohup sh /data/project/export_photo_info_count.sh -f `<span class="built_in">pwd</span>`/videos.txt -o `<span class="built_in">pwd</span>`/users.txt &amp;</span><br><span class="line">nohup sh /data/project/export_features.sh -i `<span class="built_in">pwd</span>`/videos.txt -o `<span class="built_in">pwd</span>` -t 10 -d <span class="string">"9"</span> &amp;</span><br><span class="line">nohup java -Dfile.encoding=UTF-8 -cp /data/project/chenxiaohui/kuaishou-mmu-data/*:kuaishou-mmu-data-1.0-SNAPSHOT.jar com.kuaishou.runner.BaseRunner -r  ExportTextSer    vice -i `<span class="built_in">pwd</span>`/videos.txt -o `<span class="built_in">pwd</span>`/text.txt -t 10 &amp;</span><br><span class="line">nohup sh  /data/project/export_frames.sh  `<span class="built_in">pwd</span>`/videos.txt `<span class="built_in">pwd</span>`/cover 1 100 30 &amp;</span><br></pre></td></tr></table></figure><h3 id="run-sh-导出视频相关计数"><a href="#run-sh-导出视频相关计数" class="headerlink" title="run.sh 导出视频相关计数"></a>run.sh 导出视频相关计数</h3><ul><li>bash 脚本：<code>export_photo_info_count.sh</code></li><li>功能：导出视频相关计数</li><li>输入：videos.txt</li><li>输出：users.txt</li><li>格式：photoId \t viewCount \t likeCount \t unlikeCount \t commentCount \t forwardCount \t authorId</li><li>样例：36853120853 77026 496 0 9 0 1337316458</li><li>wiki: <a href="https://docs.corp.kuaishou.com/k/home/VEPkMOB4UCl4/fcACxteH0QO2VqgPQNA1h5NOx" target="_blank" rel="external nofollow noopener noreferrer">https://docs.corp.kuaishou.com/k/home/VEPkMOB4UCl4/fcACxteH0QO2VqgPQNA1h5NOx</a></li><li>使用：<code>nohup sh /data/project/export_photo_info_count.sh -f `pwd`/videos.txt -o `pwd`/users.txt &amp;</code></li><li>程序运行参数说明：<ul><li>-f 输入文件，其中每一行是一个 photo id</li><li>-o 指定的输出文件，结果：photoId \t viewCount \t likeCount \t unlikeCount \t commentCount \t forwardCount \t authorId</li></ul></li></ul><h3 id="导出所有视频"><a href="#导出所有视频" class="headerlink" title="导出所有视频"></a>导出所有视频</h3><ul><li>webserver下，对777目录的</li><li>执行：<code>nohup sh /data/project/export_author_videos.sh -i "users.txt" -o  user_pids.txt" &amp;</code></li><li>输出：uid \t pid,pid,pid</li></ul><h3 id="run-sh-导出用户特征向量"><a href="#run-sh-导出用户特征向量" class="headerlink" title="run.sh 导出用户特征向量"></a>run.sh 导出用户特征向量</h3><ul><li>bash 脚本：<code>export_features.sh</code></li><li>功能：导出特征，-d9 是导出用户特征向量</li><li>输入：videos.txt</li><li>输出：author_2tower_embedding_by_photo_id</li><li>格式：pid \t 64 维的 embedding 向量，向量也可能为空</li><li>wiki：<a href="https://docs.corp.kuaishou.com/k/home/VBbdL4rQHmz4/fcABg6qainvICo6XTlhYqNAQN" target="_blank" rel="external nofollow noopener noreferrer">https://docs.corp.kuaishou.com/k/home/VBbdL4rQHmz4/fcABg6qainvICo6XTlhYqNAQN</a></li><li>使用：<code>nohup sh /data/project/export_features.sh -i `pwd`/videos.txt -o `pwd` -t 10 -d "9" &amp;</code></li><li>参数<ul><li>-i 指定将要传入的 photo id 数据文件，每一行一个 photo id，需要传入绝对路径，导出文件会自动生成</li><li>-o 指定输出文件的存放目录，绝对路径, 不能以”/“结尾</li><li>-t 线程个数</li><li>-d 想要的算法结果，以逗号分隔开，比如 -d “1,2”</li></ul></li><li>上述的<code>-d 9</code>表示输出<code>author_2tower_embedding_by_photo_id</code>，是推荐那边的双塔模型输出的作者信息编码，作用可以理解成这个作者偏向于发什么类型的视频。</li><li>这个后续会使用<code>generate_rec_for_raw_user_embeding_from_hive_file()</code>方法处理得到 rec</li><li>关于<code>-d</code>更多的信息看 wiki</li></ul><h3 id="run-sh-导出文本"><a href="#run-sh-导出文本" class="headerlink" title="run.sh 导出文本"></a>run.sh 导出文本</h3><ul><li>功能：导出视频相关文本，包括视频第一帧的 caption、标题 title、内容 text、OCR 结果、作者添加的视频字幕</li><li>wiki: <a href="https://docs.corp.kuaishou.com/k/home/VaBp46x_CVEw/fcABSVDkEsfNzNYd5emmlRsye" target="_blank" rel="external nofollow noopener noreferrer">https://docs.corp.kuaishou.com/k/home/VaBp46x_CVEw/fcABSVDkEsfNzNYd5emmlRsye</a></li><li>输入：videos.txt</li><li>输出：text.txt</li><li>格式：pid + caption + “\t” + title + “\t” + text + “\t” + ocr + “\t” + speech</li><li>先chmod 777 dir</li><li>命令：<code>nohup java -Dfile.encoding=UTF-8 -cp /data/project/chenxiaohui/kuaishou-mmu-data/*:kuaishou-mmu-data-1.0-SNAPSHOT.jar com.kuaishou.runner.BaseRunner -r ExportTextService -i `pwd`/videos.txt -o `pwd`/text.txt -t 10 &amp;</code></li><li>输出：<code>caption + "\t" + title + "\t" + text + "\t" + ocr + "\t" + speech</code></li><li>参数：<ul><li>-t 线程个数</li><li>-o 指定输出文件的存放目录，绝对路径, 不能以”/“结尾</li><li>输入方式一、输入指定 id 范围<ul><li>-s 开始 id</li><li>-e 结束 id</li></ul></li><li>输入方式二、输入指定 id<ul><li>-i 指定将要传入的 photo id 数据文件，每一行一个 photo id，需要传入绝对路径</li></ul></li></ul></li></ul><h3 id="run-sh-导出视频封面和指定帧"><a href="#run-sh-导出视频封面和指定帧" class="headerlink" title="run.sh 导出视频封面和指定帧"></a>run.sh 导出视频封面和指定帧</h3><ul><li>wiki: <a href="https://docs.corp.kuaishou.com/k/home/VPLKPDK8Fv-k/fcACJiIC2EN2KOKRYwvDciV0g" target="_blank" rel="external nofollow noopener noreferrer">https://docs.corp.kuaishou.com/k/home/VPLKPDK8Fv-k/fcACJiIC2EN2KOKRYwvDciV0g</a></li><li>命令：<code>nohup sh /data/project/export_frames.sh `pwd`/videos.txt `pwd`/cover 1 100 30 &amp;</code></li><li>输入：videos.txt</li><li>输出：cover 目录下的视频封面和指定帧</li><li>参数：<ul><li>第一个参数，photo id 列表文件，每一行一个 photo id，需要传入绝对路径</li><li>第二个参数，图片存储到的目录，绝对路径</li><li>第三个参数，运行类型。如果导出指定帧(type=2)，photo id 列表文件输入应该是 photo_id\t1,2,3 类型，帧 id 用逗号隔开，photo_id 和帧 id 用\t 隔开. 注意：\t 是不可见的符号，也可以用单个空格进行分割</li><li>第四个参数，线程数，最大 200</li><li>第五个参数，文件夹数量，一般为 10 (数据是按照”photo_id%文件夹数量“的方式下载存放的，请注意)，每个目录最多存放 10w 个</li></ul></li></ul><h3 id="get-user-list"><a href="#get-user-list" class="headerlink" title="get_user_list"></a>get_user_list</h3><p>准备好 author id，和<code>cut -f7 -d $'\t' users.txt | sort | uniq &gt; users_list.txt</code>效果一样</p><h3 id="run-sh-导出用户特征"><a href="#run-sh-导出用户特征" class="headerlink" title="run.sh 导出用户特征"></a>run.sh 导出用户特征</h3><ul><li>wiki: <a href="https://docs.corp.kuaishou.com/k/home/VdeW2QONo4Qw/fcAB7R1aarXIFGzBDBwTvkI0D" target="_blank" rel="external nofollow noopener noreferrer">https://docs.corp.kuaishou.com/k/home/VdeW2QONo4Qw/fcAB7R1aarXIFGzBDBwTvkI0D</a></li><li>命令：<code>sh /data/project/user_info_export.sh -i `pwd`/users_list.txt</code></li><li>输入：<code>users_list.txt</code></li><li>输出：<code>users_list_out.txt</code></li><li>格式：userId  用户名 用户简介</li><li>参数：<ul><li>-i 输入文件，其中每一行是一个 author id</li></ul></li><li>需要先准备好 author id：<code>cut -f7 -d $'\t' users.txt | sort | uniq &gt; users_list.txt</code></li><li>输出：运行成功会在输入文件的文件夹产生一个新的文件，文件名与输入文件名前缀相同，比如  author.txt 会生成  author_out.txt<br>      结果格式为 userId  用户名 用户简介</li></ul><h3 id="mk-train-org"><a href="#mk-train-org" class="headerlink" title="mk_train_org"></a>mk_train_org</h3><p>把拉取下来的，存放在 cover 目录中的数据，打上对应的 label。输出<code>train_org.txt</code>文件。</p><p>label 文件是人工标注的结果 或者自己清洗得到的</p><p>关键代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取label和对应的类别编号</span></span><br><span class="line"><span class="comment"># 0 n 其他</span></span><br><span class="line"><span class="comment"># 1 n 舞蹈</span></span><br><span class="line">labelindex={}</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'/share/yuanwei05/xingshisenlin/saishi/data/saishi_class.label'</span>,<span class="string">'r'</span>) <span class="keyword">as</span> fin:</span><br><span class="line">    <span class="keyword">for</span> l <span class="keyword">in</span> fin:</span><br><span class="line">      l=l.strip().split()</span><br><span class="line">      labelindex[l[<span class="number">2</span>]]=int(l[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给每个拉取下来存放在cover的pic，打上对应的label，结果如下</span></span><br><span class="line"><span class="comment"># /share/yangfan/yuanwei/xingshisenlin_saishi/cover/0/36872762760.jpg 0</span></span><br><span class="line"><span class="comment"># /share/yangfan/yuanwei/xingshisenlin_saishi/cover/0/36873258930.jpg 0</span></span><br><span class="line">pidlabel={}</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'./saishi_train_data_v3.txt'</span>,<span class="string">'r'</span>) <span class="keyword">as</span> fin:</span><br><span class="line">    <span class="keyword">for</span> l <span class="keyword">in</span> fin:</span><br><span class="line">      l=l.strip().split()</span><br><span class="line">      pid=l[<span class="number">0</span>]</span><br><span class="line">      label=l[<span class="number">1</span>]</span><br><span class="line">      pidlabel[pid]=label</span><br><span class="line">    <span class="comment">#with open('./coarse_train_v3/train_org.txt','w') as fout:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'./train_data_v3/train_org.txt'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> fout:</span><br><span class="line">      image_dir=<span class="string">'./cover'</span></span><br><span class="line">      <span class="keyword">for</span> target <span class="keyword">in</span> sorted(os.listdir(image_dir)):</span><br><span class="line">        d = os.path.join(image_dir, target)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(d):</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> root, _, fnames <span class="keyword">in</span> sorted(os.walk(d,followlinks=<span class="literal">True</span>)):</span><br><span class="line">          <span class="keyword">for</span> fname <span class="keyword">in</span> sorted(fnames):</span><br><span class="line">            <span class="keyword">if</span> has_file_allowed_extension(fname, IMG_EXTENSIONS):</span><br><span class="line">              path = os.path.join(root, fname)</span><br><span class="line">              image_id = fname.split(<span class="string">"."</span>)[<span class="number">0</span>]</span><br><span class="line">              <span class="keyword">if</span> <span class="string">'_'</span> <span class="keyword">in</span> image_id:</span><br><span class="line">                image_id=image_id.split(<span class="string">'_'</span>)[<span class="number">0</span>]</span><br><span class="line">              <span class="keyword">if</span> image_id <span class="keyword">in</span> pidlabel:</span><br><span class="line">                <span class="comment">#if pidlabel[image_id]=='婴儿否':</span></span><br><span class="line">                <span class="comment">#    continue</span></span><br><span class="line">                fout.write(<span class="string">'%s\t%d\n'</span>%(os.path.abspath(path),labelindex[pidlabel[image_id]]))</span><br></pre></td></tr></table></figure><h3 id="transfer-user-pid"><a href="#transfer-user-pid" class="headerlink" title="transfer_user_pid"></a>transfer_user_pid</h3><ul><li>输入<code>users_list_out.txt</code>文件</li><li>输出<code>users_profile.txt</code></li><li>输出文件格式是<code>pid 用户名 用户简介</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transfer_user_pid</span><span class="params">()</span>:</span></span><br><span class="line">    lines = open(<span class="string">'users_list_out.txt'</span>).readlines()</span><br><span class="line">    dic = {}</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        s = line.strip(<span class="string">'\n'</span>).split(<span class="string">'\t'</span>)</span><br><span class="line">        dic[s[<span class="number">0</span>]] = <span class="string">'\t'</span>.join(s[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">    lines = open(<span class="string">'users.txt'</span>).readlines()</span><br><span class="line">    output_f = open(<span class="string">'users_profile.txt'</span>, <span class="string">'w'</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        s = line.strip(<span class="string">'\n'</span>).split(<span class="string">'\t'</span>)</span><br><span class="line">        pid = s[<span class="number">0</span>]</span><br><span class="line">        info = dic[s[<span class="number">-1</span>]]</span><br><span class="line">        output_f.write(pid + <span class="string">'\t'</span> + info + <span class="string">'\n'</span>)</span><br></pre></td></tr></table></figure><h3 id="split-train-val"><a href="#split-train-val" class="headerlink" title="split_train_val"></a>split_train_val</h3><ul><li>输入：<code>train_org.txt</code></li><li>输出：<code>train_data.txt</code>和<code>val_data.txt</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_train_val</span><span class="params">(data_path, save_path)</span>:</span></span><br><span class="line">    f = open(os.path.join(data_path, <span class="string">"train_org.txt"</span>), <span class="string">"r"</span>)</span><br><span class="line">    lines = f.readlines()</span><br><span class="line">    f.close()</span><br><span class="line">    random.seed(<span class="number">123</span>)</span><br><span class="line">    random.shuffle(lines)</span><br><span class="line">    pos = int(len(lines) * <span class="number">0.95</span>)</span><br><span class="line">    train_f = open(os.path.join(save_path, <span class="string">"train_data.txt"</span>), <span class="string">"w"</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines[:pos]:</span><br><span class="line">        train_f.write(line)</span><br><span class="line">    train_f.close()</span><br><span class="line">    val_f = open(os.path.join(save_path,<span class="string">"val_data.txt"</span>), <span class="string">"w"</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines[pos:]:</span><br><span class="line">        val_f.write(line)</span><br><span class="line">    val_f.close()</span><br></pre></td></tr></table></figure><h3 id="generate-rec-for-raw-user-embeding"><a href="#generate-rec-for-raw-user-embeding" class="headerlink" title="generate_rec_for_raw_user_embeding"></a>generate_rec_for_raw_user_embeding</h3><ul><li>输入<code>text.txt, author_2tower_embedding_by_photo_id_path, users_profile.txt</code></li><li>输出<code>train.txt, val.txt, train.idx, train.rec, val.idx, val.rec</code></li><li>依赖<code>mxnet</code>和<code>encode</code>函数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(record, index, label, data)</span>:</span></span><br><span class="line">    <span class="comment">#idx_file = 'tmp.idx'</span></span><br><span class="line">    <span class="comment">#rec_file = 'tmp.rec'</span></span><br><span class="line">    <span class="comment">#record = mx.recordio.MXIndexedRecordIO(idx_file, rec_file, 'w')</span></span><br><span class="line">    header = mx.recordio.IRHeader(<span class="number">0</span>, label, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="comment">#mes = json.dumps([1,2,3])</span></span><br><span class="line">    s = mx.recordio.pack(header, data)</span><br><span class="line">    record.write_idx(index, s)</span><br></pre></td></tr></table></figure><h2 id="模型训练"><a href="#模型训练" class="headerlink" title="模型训练"></a>模型训练</h2><h3 id="bash-运行脚本"><a href="#bash-运行脚本" class="headerlink" title="bash 运行脚本"></a>bash 运行脚本</h3><p>路径：<code>/share/yuanwei/multimodal/run_saishi.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/opt/conda/envs/rapids/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> PYTHONPATH=/opt/conda/envs/rapids:<span class="variable">$PYTHONPATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># export CUDA_VISIBLE_DEVICES=0,1,2,3,5,6,7</span></span><br><span class="line"><span class="comment"># python -m torch.distributed.launch --nnodes=1 --nproc_per_node=8 --master_addr=localhost --master_port=29600 --use_env \</span></span><br><span class="line"><span class="comment">#                classy_train.py --skip_tensorboard --device=gpu --config=/share/yuanwei/xingshisenlin/saishi/configs/config_attention_ywcode_0301_data_v3.json \</span></span><br><span class="line"><span class="comment"># --num_workers=4 --log_freq=50 --distributed_backend=ddp --checkpoint_folder /share/yuanwei05/xingshisenlin/saishi/models/models_20210301 &gt; /share/yuanwei05/xingshisenlin/saishi/20210301.log 2&gt;&amp;1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># mkdir /share/yuanwei/xingshisenlin/saishi/clean_data_iter/models_20210225_focus_sub_val</span></span><br><span class="line"><span class="comment"># mv /share/yuanwei/model_test_tmp/*.txt /share/yuanwei/xingshisenlin/saishi/clean_data_iter/models_20210225_focus_sub_val</span></span><br><span class="line"><span class="comment"># wait</span></span><br><span class="line"><span class="comment"># python -m torch.distributed.launch --nnodes=1 --nproc_per_node=8 --master_addr=localhost --master_port=29600 --use_env \</span></span><br><span class="line"><span class="comment">#                classy_train.py --skip_tensorboard --device=gpu --config=/share/yuanwei/xingshisenlin/saishi/configs/config_attention_ywcode_testonly_data_v2.json \</span></span><br><span class="line"><span class="comment"># --num_workers=4 --log_freq=50 --distributed_backend=ddp --checkpoint_folder /share/yuanwei05/xingshisenlin/saishi/models/models_20210225_focus_sub &gt; /share/yuanwei05/xingshisenlin/saishi/testonly.log 2&gt;&amp;1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># mkdir /share/yuanwei/xingshisenlin/saishi/clean_data_iter/models_20210225_focus_sub_train</span></span><br><span class="line"><span class="comment"># mv /share/yuanwei/model_test_tmp/*.txt /share/yuanwei/xingshisenlin/saishi/clean_data_iter/models_20210225_focus_sub_train</span></span><br><span class="line"></span><br><span class="line">sh predict_saishi_eval.sh /share/yuanwei05/xingshisenlin/saishi/<span class="built_in">eval</span>/usemodel_0301_eval_0121-0128_prob_tmp /share/yuanwei05/xingshisenlin/saishi/models/models_20210301/checkpoint.torch 8 1</span><br><span class="line"></span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sh run_saishi_clean_data.sh</span></span><br></pre></td></tr></table></figure><h4 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h4><ul><li><p>–nnodes=1: 当前 job 包含一个节点</p></li><li><p>–nproc_per_node=8: 每个节点 8 个任务</p></li><li><p>–master_addr: master 节点的 ip</p></li><li><p>–master_port=29600: master 节点的 port</p></li><li><p>–use_env: 如果为 TRUE，用 LOCAL_RANK 环境变量给子进程传递 local_rank，这时候程 y 序不会传递–local_rank</p></li><li><p>–config: classy_train 的配置文件</p></li><li><p>num_workers: classy_vision.trainer 多线程的线程数</p></li><li><p>–distributed_backend: 用于设置 trainer_class 为 DistributedTrainer</p></li></ul><h3 id="文件说明"><a href="#文件说明" class="headerlink" title="文件说明"></a>文件说明</h3><ol><li>运行<code>/share/yuanwei/multimodal/classy_train.py</code>训练</li><li>配置文件为<code>/share/yuanwei/xingshisenlin/saishi/configs/config_attention_ywcode_0301_data_v3.json</code></li><li>保存 checkpoint 的 checkpoint_folder 为<code>/share/yuanwei05/xingshisenlin/saishi/models/models_20210301</code></li><li>预训练 ckp 为<code>/share/wuxiangyu/multimodal/models_ft/finetune.pt</code></li><li>task 文件为<code>fine_tuning_task_pretrain.py</code>，继承了<code>ClassificationTask(ClassyTask)</code>，通过<code>classy_train.py</code>中的<code>build_task(config)</code>得到</li><li>loss 文件为<code>class_multimodal_rawuser_noisetxt_noiseauthor_outtarget.py</code></li><li>原始 dataset 说明<ol><li>会直接<code>self.lines = open(meta_file).readlines()</code>读取 meta 文件</li><li>MXNet 通过索引记录文件和相应的索引文件读取<ol><li><code>self.record = mx.recordio.MXIndexedRecordIO(self.idx_file, self.rec_file, 'r')</code></li><li><code>self.record.read_idx(index)</code></li></ol></li><li>从 rec 文件中获得一些特征，text_feature，user_profile_feature，user_feature</li><li><code>__getitem__</code>返回的是<code>image, int(target), text_feature, user_profile_feature, torch.tensor(user_feature),int(index)</code></li></ol></li><li>classy_dataset 文件为<code>class_multimodal_rawuser_noisetxt_noiseauthor_outtarget.py</code>，<ol><li>其中训练文件为<code>/share/yangfan/yuanwei/xingshisenlin_saishi/train_data_v3/</code></li><li>其中 train 数据样例为<code>/share/yangfan/yuanwei/xingshisenlin_saishi/cover/11/38989219271.jpg 38989219271 38989219271 38989219271 0</code></li><li>dataset 类文件为<code>multimodal_dataset_raw_user.py</code></li><li>dataset同时会读取<code>rec</code>文件和<code>idx</code>文件</li><li>还会在其中创建 bert-tokenizer 和 transform</li><li>还会生成 noise words 和 drop words 和 target map</li><li>会将 dataset 中的<code>target</code>通过<code>"target_file": "/share/yuanwei/xingshisenlin/saishi/data/saishi_class.target</code>转换成 one-hot 编码的类别</li><li>会给<code>user_feature</code>添加 noise</li><li>会给<code>text_feature</code>按照 drop file 中的词进行 drop，就是将 drop file 中的词都删掉，然后在<code>randint(0,min(len(s),self.token_max_length-10))</code>位置随机加入一个 noise file 中的词。后面还会做 padding</li><li><code>user_profile_feature</code>和<code>text_feature</code>操作相同，但是不会 drop word 和 noise</li><li>最后会将<code>sample[0:-1]</code>进行 transform，然后加上<code>index</code>返回</li></ol></li><li>meters 文件为<code>accuracy_meter_allownegative_dict_3.py</code>，只看了基本的函数，其他还没具体看，后面遇到了再回来看</li><li>optimizer: SGD</li><li>models 文件为<code>classy_multimodal_yw_3.py</code>，其中<ol><li>image_model：resnet，内嵌</li><li>image_fc_model：mlp</li><li>text_model：nlp_new,<code>/home/xudi06/multimodal/classy_vision/models/nlp_new.py</code><ol><li>bert: bert-base-chinese</li><li>mlp</li></ol></li><li>user_profile_model：nlp_new</li><li>user_model：mlp</li><li>fuse_model: multi_head_attention_new</li><li>heads: FullyConnectedHeadFeaDict</li></ol></li></ol><h2 id="模型测试和评估"><a href="#模型测试和评估" class="headerlink" title="模型测试和评估"></a>模型测试和评估</h2><p>测试的过程大体如下：</p><ol><li>取一批新数据，没有标注，作为测试集（非验证集）</li><li>获取这些样本的data、特征等，和训练的特征一样</li><li>有两种方式喂给模型<ol><li>和训练方式相同：gputest，流程是：<ol><li>修改gputest-config，将drop和noise比例置0</li><li>和模型训练相同，只是epoch为1</li><li>在模型训练的代码中有一段代码会保存结果在一个临时目录<blockquote><p>classification_task:812<br>self.write_test[local_rank]=open(‘/share/yuanwei05/model_test_tmp/%s.txt’%(local_rank),’w’)</p></blockquote></li></ol></li><li>使用<code>run_.sh-&gt;predict_.sh-&gt;test_.sh</code>，加载checkpoint，然后一条一条读入，进行预测，得到结果。</li></ol></li><li>如果是gputest方式，手动将临时结果目录下的文件，copy到自己的目录下</li><li>使用<code>/share/yuanwei05/wudao/eval/get_shuf_202104_strategy.py</code>随机采样test结果，然后进行数据回查</li><li>在数据回查的过程中，设置一个阈值，高于这个阈值的就为真</li><li>通过阈值，每个类采样一两百给人工评，可以算出precision，近似整个测试集的precision</li><li>对于训练的模型，每个phase都会保存model，checkpoint会保存最后一个phase的model，如果模型没有过拟合，那么最后一个phase即checkpoint的结果和之前最好的model，效果差不会很大，一个点左右无所谓。</li></ol><p>最后的生成文件如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&gt; ll -t /share/yangfan/yuanwei/wudao_eval_2021_0401-0403</span><br><span class="line">total 34G</span><br><span class="line">-rw-r--r-- 1 1001 1001  19K Apr  7 12:16 data_format_gputest.py</span><br><span class="line">-rw-r--r-- 1 root root  16M Apr  7 12:14 train.idx</span><br><span class="line">-rw-r--r-- 1 root root 6.6G Apr  7 12:14 train.rec</span><br><span class="line">-rw-r--r-- 1 root root  91M Apr  7 12:14 train.txt</span><br><span class="line">-rw-r--r-- 1 root root  51M Apr  7 12:07 train_data.txt</span><br><span class="line">-rw-r--r-- 1 root root  51M Apr  7 12:04 train_org.txt</span><br><span class="line">-rw-r--r-- 1 root root 1.7G Apr  7 12:03 audio_128.txt</span><br><span class="line">-rw-r--r-- 1 root root  780 Apr  7 11:55 needRunVideoEmbedding.txt</span><br><span class="line">-rw-r--r-- 1 root root 4.1G Apr  7 11:55 video_embedding.txt</span><br><span class="line">-rw-r--r-- 1 root root  866 Apr  7 11:51 get_videoembedding.py</span><br><span class="line">-rw-rw-r-- 1 1001 1001  59M Apr  7 11:09 users_profile.txt</span><br><span class="line">-rw-rw-r-- 1 1001 1001  21G Apr  7 11:08 audio</span><br><span class="line">-rw-rw-r-- 1 1001 1001 395M Apr  7 11:08 author_2tower_embedding_by_photo_id</span><br><span class="line">-rw------- 1 1001 1001 416K Apr  7 11:08 nohup.out</span><br><span class="line">-rw-rw-r-- 1 1001 1001  33M Apr  7 11:08 users_list_out.txt</span><br><span class="line">-rw-rw-r-- 1 1001 1001 411M Apr  7 11:06 text.txt</span><br><span class="line">drwxrwxr-x 1 1001 1001   30 Apr  7 11:04 cover/</span><br><span class="line">-rw-rw-r-- 1 1001 1001 4.2M Apr  7 11:01 users_list.txt</span><br><span class="line">-rw-r--r-- 1 1001 1001  701 Apr  7 11:01 run.sh</span><br><span class="line">-rw-rw-r-- 1 1001 1001  24M Apr  7 10:55 users.txt</span><br><span class="line">-rw-r--r-- 1 root root 8.0M Apr  7 10:51 videos.txt</span><br><span class="line">-rw-r--r-- 1 root root 1.2K Apr  7 10:30 mk_train_org.py</span><br><span class="line">-rw-r--r-- 1 1001 1001 5.0K Apr  7 10:28 main.py</span><br><span class="line">-rw-r--r-- 1 1001 1001  863 Apr  7 10:28 find_noframe0.py</span><br><span class="line">-rw-r--r-- 1 1001 1001  748 Apr  7 10:28 convert_to_128.py</span><br><span class="line">-rwxr-xr-x 1 1001 1001  350 Apr  7 10:28 get_user_by_photo.sh*</span><br></pre></td></tr></table></figure><h2 id="推荐类别项目"><a href="#推荐类别项目" class="headerlink" title="推荐类别项目"></a>推荐类别项目</h2><h3 id="关键词收集"><a href="#关键词收集" class="headerlink" title="关键词收集"></a>关键词收集</h3><ul><li>推荐</li><li>必备</li><li>分享</li><li>适合</li><li>好物</li><li>推广</li></ul><h3 id="数据量"><a href="#数据量" class="headerlink" title="数据量"></a>数据量</h3><table><thead><tr><th>类别</th><th>已标注</th><th>未标注</th><th>共计</th></tr></thead><tbody><tr><td>穿搭</td><td>9993</td><td>5007</td><td>15000</td></tr><tr><td>旅游</td><td>2845</td><td>8622</td><td>11467</td></tr><tr><td>美食</td><td>8498</td><td>6520</td><td>15018</td></tr><tr><td>美妆</td><td>9027</td><td>5973</td><td>15000</td></tr><tr><td>汽车</td><td>3522</td><td>11478</td><td>15000</td></tr><tr><td>亲子</td><td>2898</td><td>10514</td><td>13412</td></tr><tr><td>游戏</td><td>3334</td><td>11666</td><td>15000</td></tr></tbody></table></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Private/" rel="tag"><i class="fa fa-tag"></i> Private</a> <a href="/tags/DeepLearning/" rel="tag"><i class="fa fa-tag"></i> DeepLearning</a> <a href="/tags/Pytorch/" rel="tag"><i class="fa fa-tag"></i> Pytorch</a> <a href="/tags/ClassyVision/" rel="tag"><i class="fa fa-tag"></i> ClassyVision</a> <a href="/tags/MultiModal/" rel="tag"><i class="fa fa-tag"></i> MultiModal</a> <a href="/tags/VideoClassification/" rel="tag"><i class="fa fa-tag"></i> VideoClassification</a> <a href="/tags/DistributedTraining/" rel="tag"><i class="fa fa-tag"></i> DistributedTraining</a></div><div class="post-nav"><div class="post-nav-item"><a href="/MachineLearning/2021-03-31-bert-finetune-analysis" rel="prev" title="BERT-FineTune源码理解"><i class="fa fa-chevron-left"></i> BERT-FineTune源码理解</a></div><div class="post-nav-item"><a href="/MachineLearning/2021-04-14-allennlp-notes" rel="next" title="AllenNLP框架学习笔记（一）">AllenNLP框架学习笔记（一） <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comment-button-group"><a class="btn comment-button disqus">disqus</a> <a class="btn comment-button gitalk">gitalk</a></div><div class="comment-position disqus"><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></div><div class="comment-position gitalk"><div class="comments" id="gitalk-container"></div></div><script>(function() {
          let commentButton = document.querySelectorAll('.comment-button');
            commentButton.forEach(element => {
            let commentClass = element.classList[2];
            element.addEventListener('click', () => {
              commentButton.forEach(active => active.classList.toggle('active', active === element));
              document.querySelectorAll('.comment-position').forEach(active => active.classList.toggle('active', active.classList.contains(commentClass)));
              if (CONFIG.comments.storage) {
                localStorage.setItem('comments_active', commentClass);
              }
            });
          });
          let { activeClass } = CONFIG.comments;
          if (CONFIG.comments.storage) {
            activeClass = localStorage.getItem('comments_active') || activeClass;
          }
          if (activeClass) {
            let activeButton = document.querySelector(`.comment-button.${activeClass}`);
            if (activeButton) {
              activeButton.click();
            }
          }
        })();</script><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Haniel Farnsworth</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span class="post-meta-item-text">Symbols count total: </span><span title="Symbols count total">508k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">Reading time total &asymp;</span> <span title="Reading time total">21:10</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://github.com/next-geek/next-geek" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Next-geek</a></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",(e=document.getElementsByTagName("script")[0]).parentNode.insertBefore(t,e)}()</script><script src="/js/local-search.js"></script><script>function loadCount(){var d=document,n=d.createElement("script");n.src="https://hanielxx.disqus.com/count.js",n.id="dsq-count-scr",(d.head||d.body).appendChild(n)}window.addEventListener("load",loadCount,!1)</script><script>var disqus_config = function() {
    this.page.url = "https://hanielxx.com/MachineLearning/2021-04-03-classy-vision-and-multimodal-video-classification";
    this.page.identifier = "MachineLearning/2021-04-03-classy-vision-and-multimodal-video-classification.html";
    this.page.title = "ClassyVision框架和多模态视频分类流程";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://hanielxx.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });</script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script>NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '27e3eba13ef3780f492b',
      clientSecret: '4e28d0b26bbf1501e220a7d94b983aec4e4c11df',
      repo        : 'CommentsRepo',
      owner       : 'HanielF',
      admin       : ['HanielF'],
      id          : '932dabc91ae037046b3bac1987a537ed',
        language: 'en',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});</script></body></html>